generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id               String          @id @default(uuid())
  userId           String          @map("user_id")
  title            String
  status           ProjectStatus   @default(DRAFT)
  contentType      ContentType     @map("content_type")
  tonePreference   TonePreference  @map("tone_preference")
  targetLength     Int             @map("target_length")
  versionCount     Int             @default(0) @map("version_count")
  currentVersionId String?         @map("current_version_id")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  sources Source[]
  drafts  Draft[]

  @@index([userId])
  @@index([status])
  @@map("projects")
}

model Source {
  id                String           @id @default(uuid())
  projectId         String           @map("project_id")
  sourceType        SourceType       @map("source_type")
  originalPath      String           @map("original_path")
  extractedText     String           @map("extracted_text")
  metadata          Json             @default("{}")
  processingStatus  ProcessingStatus @default(PENDING) @map("processing_status")
  createdAt         DateTime         @default(now()) @map("created_at")

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  insights Insight[]

  @@index([projectId])
  @@index([processingStatus])
  @@map("sources")
}

model Insight {
  id               String   @id @default(uuid())
  sourceId         String   @map("source_id")
  content          String
  insightType      String   @map("insight_type")
  confidenceScore  Float    @map("confidence_score")
  relatedInsights  String[] @default([]) @map("related_insights")
  extractedAt      DateTime @default(now()) @map("extracted_at")

  source Source @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@index([sourceId])
  @@map("insights")
}

model Draft {
  id              String   @id @default(uuid())
  projectId       String   @map("project_id")
  versionNumber   Int      @map("version_number")
  content         String
  outline         Json     @default("{}")
  citations       Json     @default("[]")
  qualityScore    Float    @default(0) @map("quality_score")
  generationTime  Int      @map("generation_time")
  parentDraftId   String?  @map("parent_draft_id")
  createdAt       DateTime @default(now()) @map("created_at")

  project   Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  revisions Revision[]

  @@index([projectId])
  @@index([versionNumber])
  @@map("drafts")
}

model Revision {
  id                    String   @id @default(uuid())
  draftId               String   @map("draft_id")
  feedback              String
  feedbackType          String   @map("feedback_type")
  changeSummary         String   @map("change_summary")
  alternativesGenerated Int      @default(0) @map("alternatives_generated")
  alternativeSelected   Int      @default(0) @map("alternative_selected")
  intentPreserved       Boolean  @default(false) @map("intent_preserved")
  createdAt             DateTime @default(now()) @map("created_at")

  draft   Draft    @relation(fields: [draftId], references: [id], onDelete: Cascade)
  changes Change[]

  @@index([draftId])
  @@map("revisions")
}

model Change {
  id            String    @id @default(uuid())
  revisionId    String    @map("revision_id")
  changeType    String    @map("change_type")
  location      Json      @default("{}")
  beforeState   String    @map("before_state")
  afterState    String    @map("after_state")
  rationale     String
  userApproved  Boolean   @default(false) @map("user_approved")
  createdAt     DateTime  @default(now()) @map("created_at")

  revision Revision @relation(fields: [revisionId], references: [id], onDelete: Cascade)

  @@index([revisionId])
  @@map("changes")
}

enum ProjectStatus {
  DRAFT
  DISTILLING
  GENERATING
  REFINING
  COMPLETED
  ARCHIVED
}

enum ContentType {
  BLOG
  ARTICLE
  REPORT
  SUMMARY
}

enum TonePreference {
  FORMAL
  CASUAL
  TECHNICAL
  PERSUASIVE
}

enum SourceType {
  FILE
  URL
  NOTE
  TRANSCRIPT
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
